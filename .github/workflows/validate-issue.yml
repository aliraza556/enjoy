name: Validate Issue

on:
  issues:
    types: [opened]

concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate Issue
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const author = issue.user.login;
            const labels = issue.labels.map(l => l.name);
            
            console.log('üìã Validating issue from:', author);
            console.log('Labels:', labels);
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üïê TIME-BASED SYSTEM
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const TIME_PERIODS = {
              dawn:      { start: 5,  end: 8,  emoji: 'üåÖ', name: 'Dawn',      multiplier: 1.2,  mood: 'The early bird catches the karma' },
              morning:   { start: 8,  end: 12, emoji: '‚òÄÔ∏è', name: 'Morning',   multiplier: 1.3,  mood: 'Fresh minds, fresh code' },
              noon:      { start: 12, end: 15, emoji: 'üåû', name: 'Solar Peak',multiplier: 1.5,  mood: 'Maximum energy flow' },
              afternoon: { start: 15, end: 18, emoji: 'üå§Ô∏è', name: 'Afternoon', multiplier: 1.25, mood: 'Steady and focused' },
              sunset:    { start: 18, end: 21, emoji: 'üåÜ', name: 'Sunset',    multiplier: 1.15, mood: 'Golden hour contributions' },
              night:     { start: 21, end: 5,  emoji: 'üåô', name: 'Night',     multiplier: 1.4,  mood: 'Night owl bonus active' }
            };
            
            function getCETHour() {
              const now = new Date();
              const cetTime = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Rome" }));
              return cetTime.getHours();
            }
            
            function getCurrentPeriod() {
              const hour = getCETHour();
              for (const [key, period] of Object.entries(TIME_PERIODS)) {
                if (key === 'night') {
                  if (hour >= 21 || hour < 5) return { key, ...period };
                } else if (hour >= period.start && hour < period.end) {
                  return { key, ...period };
                }
              }
              return { key: 'night', ...TIME_PERIODS.night };
            }
            
            const timePeriod = getCurrentPeriod();
            const cetHour = getCETHour();
            console.log(`üïê Current time period: ${timePeriod.name} (CET ${cetHour}:00)`);
            console.log(`‚è±Ô∏è Time multiplier: x${timePeriod.multiplier}`);
            
            // Skip bots
            if (author.includes('bot') || author.includes('[bot]')) {
              console.log('ü§ñ Bot detected, skipping');
              core.setOutput('valid', 'false');
              core.setOutput('reason', 'bot');
              core.setOutput('time_period', timePeriod.name);
              core.setOutput('time_emoji', timePeriod.emoji);
              return;
            }
            
            // Skip pinned issues (official content)
            if (labels.includes('pinned')) {
              console.log('üìå Pinned issue detected, auto-approving');
              core.setOutput('valid', 'true');
              core.setOutput('reason', 'pinned');
              core.setOutput('karma', '0');
              core.setOutput('time_period', timePeriod.name);
              core.setOutput('time_emoji', timePeriod.emoji);
              return;
            }
            
            // Skip good first issues (welcoming content)
            if (labels.includes('good first issue')) {
              console.log('üå± Good first issue detected, auto-approving');
              core.setOutput('valid', 'true');
              core.setOutput('reason', 'good_first_issue');
              core.setOutput('karma', '0');
              core.setOutput('time_period', timePeriod.name);
              core.setOutput('time_emoji', timePeriod.emoji);
              return;
            }
            
            // Skip bounty issues
            if (labels.includes('bounty')) {
              console.log('üèÜ Bounty issue detected, auto-approving');
              core.setOutput('valid', 'true');
              core.setOutput('reason', 'bounty');
              core.setOutput('karma', '0');
              core.setOutput('time_period', timePeriod.name);
              core.setOutput('time_emoji', timePeriod.emoji);
              return;
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ANTI-BOT: Proof of Humanity
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const SACRED_ANSWERS = ['karmiel', 'KARMIEL', 'Karmiel'];
            
            // Look for guardian answer in issue body
            const guardianMatch = body.match(/Proof of Humanity[^\n]*\n+([^\n]+)/i) ||
                                  body.match(/guardian[^\n]*\n+([^\n]+)/i);
            
            let guardianAnswer = '';
            if (guardianMatch && guardianMatch[1]) {
              guardianAnswer = guardianMatch[1].trim();
            }
            
            const isHuman = SACRED_ANSWERS.some(s => guardianAnswer.toLowerCase().includes(s.toLowerCase()));
            
            if (!isHuman) {
              console.log('‚ùå Failed Proof of Humanity');
              console.log('Answer found:', guardianAnswer);
              core.setOutput('valid', 'false');
              core.setOutput('reason', 'not_human');
              core.setOutput('time_period', timePeriod.name);
              core.setOutput('time_emoji', timePeriod.emoji);
              core.setOutput('time_multiplier', timePeriod.multiplier.toString());
              return;
            }
            
            console.log('‚úÖ Proof of Humanity passed');
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // KARMA CALCULATION (with TIME MULTIPLIER)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            let baseKarma = 5; // Base karma for valid issue
            let karmaReason = ['Base: +5'];
            
            // Issue type bonuses
            if (labels.includes('bug')) {
              baseKarma += 10;
              karmaReason.push('Bug report: +10');
            }
            
            if (labels.includes('idea')) {
              baseKarma += 5;
              karmaReason.push('Idea: +5');
            }
            
            // Quality bonuses
            const wordMatch = body.match(/Your Word[^\n]*\n+([^\n]+)/i);
            if (wordMatch && wordMatch[1]) {
              const word = wordMatch[1].trim();
              if (word.length >= 5 && word.length <= 15) {
                baseKarma += 5;
                karmaReason.push('Good word length: +5');
              }
            }
            
            // Explanation bonus
            const whyMatch = body.match(/Why this word[^\n]*\n+([\s\S]*?)(?=\n##|\n-\s*\[|$)/i);
            if (whyMatch && whyMatch[1] && whyMatch[1].trim().length > 20) {
              baseKarma += 10;
              karmaReason.push('Good explanation: +10');
            }
            
            // Severity bonus for bugs
            if (body.includes('Critical')) {
              baseKarma += 15;
              karmaReason.push('Critical bug: +15');
            } else if (body.includes('Major')) {
              baseKarma += 10;
              karmaReason.push('Major bug: +10');
            }
            
            // Steps to reproduce bonus
            if (body.includes('Steps to Reproduce') && body.match(/\d\.\s/g)?.length >= 2) {
              baseKarma += 5;
              karmaReason.push('Good repro steps: +5');
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // APPLY TIME MULTIPLIER
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const finalKarma = Math.round(baseKarma * timePeriod.multiplier);
            karmaReason.push(`${timePeriod.emoji} ${timePeriod.name} bonus: x${timePeriod.multiplier}`);
            
            console.log('üíé Base karma:', baseKarma);
            console.log(`‚è±Ô∏è Time multiplier: x${timePeriod.multiplier}`);
            console.log('üíé Final karma:', finalKarma);
            console.log('Breakdown:', karmaReason.join(', '));
            
            core.setOutput('valid', 'true');
            core.setOutput('karma', finalKarma.toString());
            core.setOutput('base_karma', baseKarma.toString());
            core.setOutput('karma_reason', karmaReason.join(', '));
            core.setOutput('author', author);
            core.setOutput('time_period', timePeriod.name);
            core.setOutput('time_emoji', timePeriod.emoji);
            core.setOutput('time_multiplier', timePeriod.multiplier.toString());
            core.setOutput('time_mood', timePeriod.mood);

      - name: Update State (if valid)
        if: steps.validate.outputs.valid == 'true'
        run: |
          node --input-type=module -e "
            import { readFileSync, writeFileSync } from 'fs';
            
            const state = JSON.parse(readFileSync('./state.json', 'utf8'));
            const author = '${{ steps.validate.outputs.author }}';
            const karma = parseInt('${{ steps.validate.outputs.karma }}') || 5;
            
            // Initialize player if new
            if (!state.players[author]) {
              state.players[author] = {
                karma: 0,
                prs: 0,
                issues: 0,
                joined: new Date().toISOString()
              };
              state.meta.total_players++;
            }
            
            // Add karma from issue
            state.players[author].karma += karma;
            state.players[author].issues = (state.players[author].issues || 0) + 1;
            
            // Update global score (issues count less than PRs)
            state.score.total += Math.floor(karma / 2);
            state.last_updated = new Date().toISOString();
            
            writeFileSync('./state.json', JSON.stringify(state, null, 2));
            console.log('‚úÖ State updated: +' + karma + ' karma for ' + author);
          "

      - name: Commit State
        if: steps.validate.outputs.valid == 'true'
        run: |
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
          git add state.json
          git diff --staged --quiet || git commit -m "üéÆ Issue karma: +${{ steps.validate.outputs.karma }} for @${{ steps.validate.outputs.author }} [skip ci]"
          git push || echo "Nothing to push"

      - name: Comment on Issue (Valid)
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const karma = '${{ steps.validate.outputs.karma }}';
            const baseKarma = '${{ steps.validate.outputs.base_karma }}';
            const reason = '${{ steps.validate.outputs.karma_reason }}';
            const timePeriod = '${{ steps.validate.outputs.time_period }}';
            const timeEmoji = '${{ steps.validate.outputs.time_emoji }}';
            const timeMultiplier = '${{ steps.validate.outputs.time_multiplier }}';
            const timeMood = '${{ steps.validate.outputs.time_mood }}';
            
            const body = [
              `## ‚úÖ Welcome to the game, @${context.payload.issue.user.login}!`,
              '',
              `### ${timeEmoji} ${timePeriod} Mode Active`,
              `> *"${timeMood}"*`,
              '',
              '| Metric | Value |',
              '|--------|-------|',
              '| üîê **Proof of Humanity** | Passed |',
              `| üíé **Base Karma** | +${baseKarma} |`,
              `| ‚è±Ô∏è **Time Multiplier** | x${timeMultiplier} |`,
              `| üåü **Final Karma** | **+${karma}** |`,
              '',
              '**Karma Breakdown:**',
              ...reason.split(', ').map(r => '- ' + r),
              '',
              '---',
              '',
              '### What\'s Next?',
              '- üîÄ [Open a PR](https://github.com/fabriziosalmi/enjoy) for even more karma',
              '- üåê [See the leaderboard](https://fabriziosalmi.github.io/enjoy/)',
              '- ‚è∞ [Check time bonuses](https://fabriziosalmi.github.io/enjoy/time.html)',
              '',
              '*"Every voice shapes the organism."* ‚Äî Karmiel'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
            
            // Add validated label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['validated', 'karma-awarded']
            });
            
            // Remove needs-validation
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'needs-validation'
              });
            } catch (e) {}

      - name: Comment on Issue (Invalid)
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.validate.outputs.reason }}';
            const timePeriod = '${{ steps.validate.outputs.time_period }}' || 'Unknown';
            const timeEmoji = '${{ steps.validate.outputs.time_emoji }}' || '‚è∞';
            const timeMultiplier = '${{ steps.validate.outputs.time_multiplier }}' || '1.0';
            
            let message = '';
            if (reason === 'not_human') {
              message = [
                '## ‚ùå Proof of Humanity Failed',
                '',
                `### ${timeEmoji} Current Time: ${timePeriod}`,
                '',
                `@${context.payload.issue.user.login}, your issue couldn't be validated.`,
                '',
                '**What went wrong:**',
                '- The Guardian\'s name is incorrect or missing',
                '',
                '**How to fix:**',
                '1. Read [LORE.md](https://github.com/fabriziosalmi/enjoy/blob/main/LORE.md) carefully',
                '2. Look for a quote at the bottom...',
                '3. Edit this issue with the correct answer',
                '',
                `üí° **Tip:** Fix it now while the **x${timeMultiplier} ${timePeriod} bonus** is active!`,
                '',
                '*"Only those who seek shall find."* ‚Äî ???'
              ].join('\n');
            } else {
              message = [
                '## ü§ñ Bot Detected',
                '',
                `### ${timeEmoji} ${timePeriod}`,
                '',
                'This issue appears to be from a bot. No karma awarded.'
              ].join('\n');
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['invalid', 'needs-human']
            });
