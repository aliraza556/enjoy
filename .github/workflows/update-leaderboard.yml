name: Update Leaderboard

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'state.json'
      - 'words/**'

# Prevent concurrent leaderboard updates that could conflict with state changes
concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  update-leaderboard:
    runs-on: [self-hosted, enjoy-trusted]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
      
      - name: Configure git
        run: |
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
      
      - name: Generate Leaderboard
        run: |
          echo "Generating leaderboard from state.json..."
          
          LEVEL=$(jq -r '.levels.current // 1' state.json)
          TOTAL_KARMA=$(jq -r '.score.total // 0' state.json)
          PLAYER_COUNT=$(jq -r '.meta.total_players // 0' state.json)
          TOTAL_PRS=$(jq -r '.meta.total_prs // 0' state.json)
          
          # Generate rankings
          RANKINGS=$(jq -r '.players | to_entries | sort_by(.value.karma) | reverse | to_entries | .[:10][] | if .key == 0 then "| ðŸ¥‡ | \(.value.key) | \(.value.value.karma) | \(.value.value.streak) | \(.value.value.achievements | length) |" elif .key == 1 then "| ðŸ¥ˆ | \(.value.key) | \(.value.value.karma) | \(.value.value.streak) | \(.value.value.achievements | length) |" elif .key == 2 then "| ðŸ¥‰ | \(.value.key) | \(.value.value.karma) | \(.value.value.streak) | \(.value.value.achievements | length) |" else "| \(.key + 1) | \(.value.key) | \(.value.value.karma) | \(.value.value.streak) | \(.value.value.achievements | length) |" end' state.json)
          
          [ -z "$RANKINGS" ] && RANKINGS="| ðŸ¥‡ | *Join now!* | - | - | - |"
          
          # Generate founders
          FOUNDERS=$(jq -r '.players | to_entries | sort_by(.value.joined) | to_entries | .[:50][] | if .key == 0 then "| \(.key + 1) | ðŸ† \(.value.key) | \(.value.value.joined | split("T")[0]) |" else "| \(.key + 1) | ðŸŽ® \(.value.key) | \(.value.value.joined | split("T")[0]) |" end' state.json)
          
          [ -z "$FOUNDERS" ] && FOUNDERS="| 1 | *Be the first!* | ? |"
          
          # Achievers
          ACHIEVERS=$(jq -r '.players | to_entries | sort_by(.value.achievements | length) | reverse | .[:5][] | "| \(.key) | \(.value.achievements | length) |"' state.json)
          
          # Streakers
          STREAKERS=$(jq -r '.players | to_entries | sort_by(.value.streak) | reverse | .[:5][] | "| \(.key) | \(.value.streak) day(s) |"' state.json)
          
          cat > .github/LEADERBOARD.md << LEADERBOARD_EOF
          # ðŸ“Š Live Leaderboard
          
          *Auto-updated by GitHub Actions*
          
          ## Top Players by Karma
          
          | Rank | Player | Karma | Streak | Achievements |
          |------|--------|-------|--------|--------------|
          $RANKINGS
          
          ## ðŸ›ï¸ Founders Hall of Fame
          
          *First 50 players to join receive the eternal FOUNDER badge*
          
          | # | Founder | Joined |
          |---|---------|--------|
          $FOUNDERS
          
          ## Achievement Hunters
          
          | Player | Achievement Count |
          |--------|-------------------|
          $ACHIEVERS
          
          ## Streak Champions
          
          | Player | Current Streak |
          |--------|----------------|
          $STREAKERS
          
          ---
          
          ## Game Stats
          
          - **Total Players**: $PLAYER_COUNT
          - **Total Karma**: $TOTAL_KARMA
          - **Current Level**: $LEVEL
          - **Total PRs**: $TOTAL_PRS
          
          ---
          
          *Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*
          LEADERBOARD_EOF
          
          sed -i 's/^          //' .github/LEADERBOARD.md
          cat .github/LEADERBOARD.md
      
      - name: Commit and Push
        run: |
          git add .github/LEADERBOARD.md
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit"
          else
            git commit -m "ðŸ“Š Update leaderboard [skip ci]"
            if ! git push; then
              echo "::warning::Push failed - may require manual sync or retry"
              exit 1
            fi
          fi
      
      - name: Update Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit 9 --body-file .github/LEADERBOARD.md 2>/dev/null || echo "Issue #9 not found"
