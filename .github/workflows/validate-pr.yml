name: Validate PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout PR branch
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch
      
      - name: Get changed files
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const added = files.filter(f => f.status === 'added').map(f => f.filename);
            const modified = files.filter(f => f.status === 'modified').map(f => f.filename);
            const removed = files.filter(f => f.status === 'removed').map(f => f.filename);
            
            core.exportVariable('PR_FILES_ADDED', added.join(','));
            core.exportVariable('PR_FILES_MODIFIED', modified.join(','));
            core.exportVariable('PR_FILES_REMOVED', removed.join(','));
            core.exportVariable('PR_AUTHOR', context.payload.pull_request.user.login);
            core.exportVariable('PR_TITLE', context.payload.pull_request.title);
            core.exportVariable('PR_BODY', context.payload.pull_request.body || '');
            
            console.log('Added files:', added);
            console.log('Modified files:', modified);
            console.log('Removed files:', removed);
      
      - name: ï¿½ Validate PR Format
        id: format
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = process.env.PR_BODY || '';
            const prAuthor = process.env.PR_AUTHOR || '';
            
            // Skip for bots
            if (prAuthor.includes('bot') || prAuthor === 'dependabot[bot]') {
              core.setOutput('valid_format', 'true');
              core.setOutput('skip_reason', 'bot_allowed');
              console.log('ğŸ¤– Bot detected, skipping format check');
              return;
            }
            
            const errors = [];
            const warnings = [];
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK 1: Guardian Question (Proof of Humanity)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const SACRED_ANSWERS = ['karmiel', 'KARMIEL', 'Karmiel'];
            const guardianMatch = prBody.match(/What is the name of the First Guardian\?\*?\*?\s*(.+?)(?:\n|---|$)/i);
            
            let guardianAnswer = '';
            if (guardianMatch && guardianMatch[1]) {
              guardianAnswer = guardianMatch[1].trim();
            }
            
            const hasGuardianAnswer = SACRED_ANSWERS.some(s => guardianAnswer.includes(s));
            if (!hasGuardianAnswer) {
              errors.push({
                field: 'Guardian Question',
                issue: 'Missing or wrong answer',
                hint: 'Read LORE.md to find the First Guardian name'
              });
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK 2: Word Field
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const wordMatch = prBody.match(/\*\*Word:\*\*\s*(.+?)(?:\n|$)/i);
            let word = '';
            if (wordMatch && wordMatch[1]) {
              word = wordMatch[1].trim();
            }
            
            if (!word || word === '' || word.includes('<!--')) {
              errors.push({
                field: 'Word',
                issue: 'Word field is empty',
                hint: 'Add your creative word after "**Word:**"'
              });
            } else if (word.length < 3) {
              errors.push({
                field: 'Word',
                issue: 'Word too short (min 3 chars)',
                hint: 'Choose a more substantial word'
              });
            } else if (word.length > 30) {
              errors.push({
                field: 'Word',
                issue: 'Word too long (max 30 chars)',
                hint: 'Keep it concise'
              });
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK 3: Checklist (at least 3 boxes checked)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const checkedBoxes = (prBody.match(/- \[x\]/gi) || []).length;
            const uncheckedBoxes = (prBody.match(/- \[ \]/g) || []).length;
            const totalBoxes = checkedBoxes + uncheckedBoxes;
            
            if (totalBoxes === 0) {
              errors.push({
                field: 'Checklist',
                issue: 'No checklist found',
                hint: 'Use the PR template with checkboxes'
              });
            } else if (checkedBoxes < 3) {
              errors.push({
                field: 'Checklist',
                issue: `Only ${checkedBoxes}/${totalBoxes} boxes checked`,
                hint: 'Read and check all requirements you meet'
              });
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK 4: Required sections exist
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const hasProofSection = prBody.includes('Proof of Humanity') || prBody.includes('First Guardian');
            const hasWordSection = prBody.includes('**Word:**') || prBody.includes('My Contribution');
            const hasChecklist = prBody.includes('Checklist') || prBody.includes('- [');
            
            if (!hasProofSection) {
              errors.push({
                field: 'Template',
                issue: 'Missing Proof of Humanity section',
                hint: 'Use the PR template provided'
              });
            }
            
            if (!hasWordSection) {
              errors.push({
                field: 'Template', 
                issue: 'Missing Word section',
                hint: 'Use the PR template provided'
              });
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // OUTPUT RESULTS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const isValid = errors.length === 0;
            
            core.setOutput('valid_format', isValid ? 'true' : 'false');
            core.setOutput('errors_count', errors.length.toString());
            core.setOutput('errors_json', JSON.stringify(errors));
            core.setOutput('word', word);
            core.setOutput('guardian_answer', guardianAnswer);
            core.setOutput('checked_boxes', checkedBoxes.toString());
            
            if (isValid) {
              console.log('âœ… PR Format is VALID');
              console.log('ğŸ“ Word:', word);
              console.log('ğŸ” Guardian:', guardianAnswer);
              console.log('â˜‘ï¸ Checkboxes:', checkedBoxes);
            } else {
              console.log('âŒ PR Format is INVALID');
              console.log('');
              errors.forEach((e, i) => {
                console.log(`${i+1}. [${e.field}] ${e.issue}`);
                console.log(`   ğŸ’¡ ${e.hint}`);
              });
            }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd engine
          npm ci
      
      - name: Build engine
        run: |
          cd engine
          npm run build
      
      - name: Validate PR
        id: validate
        run: |
          cd engine
          node dist/index.js validate --pr-number=${{ github.event.pull_request.number }}
        continue-on-error: true
      
      - name: Analyze Karma
        id: karma
        run: |
          cd engine
          node -e "
            const fs = require('fs');
            const { loadState } = require('./dist/loader.js');
            const { analyzeContributionQuality } = require('./dist/karma.js');
            const { extractReferral } = require('./dist/validator.js');
            
            const state = loadState();
            let result = { valid: false };
            try {
              result = JSON.parse(fs.readFileSync('validation-result.json', 'utf8'));
            } catch(e) {}
            
            if (!result.valid) {
              fs.writeFileSync('karma-result.json', JSON.stringify({ skipped: true }));
              process.exit(0);
            }
            
            const addedFiles = (process.env.PR_FILES_ADDED || '').split(',').filter(f => f);
            let content = '';
            if (addedFiles.length > 0 && fs.existsSync(addedFiles[0])) {
              content = fs.readFileSync(addedFiles[0], 'utf8').trim();
            }
            
            const pr = {
              number: ${{ github.event.pull_request.number }},
              author: process.env.PR_AUTHOR || 'unknown',
              commit_message: process.env.PR_TITLE || '',
              files_added: addedFiles,
              timestamp: new Date().toISOString()
            };
            
            const karma = analyzeContributionQuality(pr, content, state);
            const referral = extractReferral(process.env.PR_BODY || '');
            
            const karmaResult = {
              quality_score: karma.quality_score,
              action: karma.action,
              amplification: karma.amplification_factor,
              referral: referral,
              reasons: karma.reasons
            };
            
            fs.writeFileSync('karma-result.json', JSON.stringify(karmaResult, null, 2));
            console.log('Karma:', JSON.stringify(karmaResult, null, 2));
          "
        continue-on-error: true
      
      - name: Read results
        id: result
        run: |
          if [ -f engine/validation-result.json ]; then
            VALID=$(jq -r '.valid' engine/validation-result.json)
            REASON=$(jq -r '.reason // ""' engine/validation-result.json)
            RULES=$(jq -r '.matched_rules | join(", ")' engine/validation-result.json)
            POINTS=$(jq -r '.points' engine/validation-result.json)
            
            echo "valid=$VALID" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            echo "rules=$RULES" >> $GITHUB_OUTPUT
            echo "points=$POINTS" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "reason=Validation failed to run" >> $GITHUB_OUTPUT
          fi
          
          if [ -f engine/karma-result.json ]; then
            KARMA_SCORE=$(jq -r '.quality_score // 0' engine/karma-result.json)
            KARMA_ACTION=$(jq -r '.action // "accept"' engine/karma-result.json)
            KARMA_AMP=$(jq -r '.amplification // 1' engine/karma-result.json)
            REFERRAL=$(jq -r '.referral // ""' engine/karma-result.json)
            
            echo "karma_score=$KARMA_SCORE" >> $GITHUB_OUTPUT
            echo "karma_action=$KARMA_ACTION" >> $GITHUB_OUTPUT
            echo "karma_amp=$KARMA_AMP" >> $GITHUB_OUTPUT
            echo "referral=$REFERRAL" >> $GITHUB_OUTPUT
          fi
      
      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            const validFormat = '${{ steps.format.outputs.valid_format }}' === 'true';
            const valid = '${{ steps.result.outputs.valid }}' === 'true';
            const karmaAction = '${{ steps.result.outputs.karma_action }}';
            const karmaAmp = parseInt('${{ steps.result.outputs.karma_amp }}') || 1;
            
            const labelsToCreate = [
              { name: 'auto-merge', color: '0e8a16', description: 'Ready for auto-merge' },
              { name: 'invalid', color: 'd93f0b', description: 'Invalid contribution' },
              { name: 'karma-x2', color: 'fbca04', description: 'x2 amplification' },
              { name: 'karma-x3', color: 'b60205', description: 'x3 amplification' },
              { name: 'refused', color: '000000', description: 'Refused by karma' },
              { name: 'format-error', color: '5319e7', description: 'PR format is invalid' },
              { name: 'needs-fix', color: 'e99695', description: 'Needs changes to pass' }
            ];
            
            for (const label of labelsToCreate) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ...label
                });
              } catch (e) {}
            }
            
            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              for (const label of labels) {
                if (['auto-merge', 'invalid', 'karma-x2', 'karma-x3', 'refused', 'format-error', 'needs-fix'].includes(label.name)) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label.name
                  }).catch(() => {});
                }
              }
            } catch (e) {}
            
            const newLabels = [];
            
            if (!validFormat) {
              newLabels.push('format-error', 'needs-fix');
            } else if (karmaAction === 'refuse') {
              newLabels.push('refused', 'invalid');
            } else if (valid) {
              newLabels.push('auto-merge');
              if (karmaAmp === 2) newLabels.push('karma-x2');
              if (karmaAmp === 3) newLabels.push('karma-x3');
            } else {
              newLabels.push('invalid', 'needs-fix');
            }
            
            if (newLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: newLabels
              });
            }
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const validFormat = '${{ steps.format.outputs.valid_format }}' === 'true';
            const errorsJson = '${{ steps.format.outputs.errors_json }}';
            const valid = '${{ steps.result.outputs.valid }}' === 'true';
            const reason = `${{ steps.result.outputs.reason }}`;
            const rules = '${{ steps.result.outputs.rules }}';
            const points = '${{ steps.result.outputs.points }}';
            const karmaScore = '${{ steps.result.outputs.karma_score }}';
            const karmaAction = '${{ steps.result.outputs.karma_action }}';
            const karmaAmp = '${{ steps.result.outputs.karma_amp }}';
            const referral = '${{ steps.result.outputs.referral }}';
            
            let body;
            
            // FIRST CHECK: PR Format
            if (!validFormat) {
              let errors = [];
              try {
                errors = JSON.parse(errorsJson);
              } catch(e) {}
              
              body = `## ğŸ“‹ PR Format Invalid\n\n`;
              body += `Your PR doesn't follow the required format. Fix these issues:\n\n`;
              
              if (errors.length > 0) {
                body += `| # | Field | Issue | Hint |\n`;
                body += `|---|-------|-------|------|\n`;
                errors.forEach((e, i) => {
                  body += `| ${i+1} | **${e.field}** | ${e.issue} | ğŸ’¡ ${e.hint} |\n`;
                });
                body += `\n`;
              }
              
              body += `### How to fix:\n`;
              body += `1. Edit your PR description\n`;
              body += `2. Use the [PR template](../blob/main/.github/PULL_REQUEST_TEMPLATE.md)\n`;
              body += `3. Fill in ALL required fields\n`;
              body += `4. Check the boxes for requirements you meet\n\n`;
              body += `> *"The format is the ritual. The ritual is the game."*\n\n`;
              body += `---\n_Enjoy and contribute!_ âœ¨`;
            } else if (karmaAction === 'refuse') {
              body = `## âŒ Contribution Refused\n\n`;
              body += `**Karma Score:** ${karmaScore}/100\n`;
              body += `**Reason:** Low quality contribution.\n\n`;
              body += `Tips:\n- Use creative words (5-10 chars)\n- Avoid "test", "hello", "foo"\n- No duplicates\n\n`;
              body += `---\n_Enjoy and contribute!_`;
            } else if (valid) {
              body = `## âœ… Valid Contribution!\n\n`;
              body += `**Rules:** ${rules}\n`;
              body += `**Points:** +${points}\n`;
              body += `**Karma:** ${karmaScore}/100\n\n`;
              
              if (karmaAmp === '3') {
                body += `### ğŸŒŸ LEGENDARY! x3 AMPLIFICATION!\n\n`;
              } else if (karmaAmp === '2') {
                body += `### âœ¨ Excellent! x2 AMPLIFICATION!\n\n`;
              }
              
              if (referral && referral !== 'null') {
                body += `**Referred by:** @${referral}\n\n`;
              }
              
              body += `Auto-merging shortly! ğŸ‰\n\n---\n_Enjoy and contribute!_`;
            } else {
              body = `## âŒ Invalid Contribution\n\n**Reason:** ${reason}\n\n---\n_Enjoy and contribute!_`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
      
      - name: Fail if format invalid
        if: steps.format.outputs.valid_format != 'true'
        run: |
          echo "ğŸ“‹ PR Format validation failed!"
          echo "Please edit your PR to follow the required format."
          echo ""
          echo "Required fields:"
          echo "  - Guardian Question (Proof of Humanity)"
          echo "  - Word field"
          echo "  - Checklist (at least 3 boxes checked)"
          exit 1
